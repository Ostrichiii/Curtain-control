<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control Panel</title>
  <script src="/static/socket.io.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    body {
      height: calc(var(--vh, 1vh) * 100);
    }
  </style>
</head>
<body class="bg-gray-900 flex flex-col text-white overflow-hidden">

<div class="flex flex-col h-full px-4 py-2 gap-2">

  <!-- Limit indicators -->
  <div class="flex justify-center gap-6 text-sm bg-gray-800 p-2 rounded-xl">
    <div class="flex items-center gap-1">
      <div id="topLimit" class="w-3 h-3 rounded-full bg-green-500"></div>
      Top Limit
    </div>
    <div class="flex items-center gap-1">
      <div id="bottomLimit" class="w-3 h-3 rounded-full bg-green-500"></div>
      Bottom Limit
    </div>
  </div>

  <!-- Buttons -->
  <div class="flex flex-col flex-grow gap-2 min-h-0">
    <button id="upBtn" class="control-btn bg-green-500">UP</button>
    <button id="stopBtn" class="control-btn bg-yellow-500">STOP</button>
    <button id="downBtn" class="control-btn bg-red-600">DOWN</button>
  </div>

  <!-- Connected + motion info + log (click to toggle) -->
  <div id="infoPanel" class="bg-gray-800 rounded-xl text-sm p-2 flex flex-col h-10 cursor-pointer select-none transition-all duration-300">
    <div class="flex justify-between items-center mb-1">
      <div class="flex items-center gap-2 text-green-400">
        <div class="w-2 h-2 rounded-full bg-green-500"></div>
        Connected
      </div>
      <div id="motionInfo" class="text-white text-xs opacity-80">
        ⏹ Stopped · 0s
      </div>
    </div>
    <div id="logBox" class="overflow-y-auto flex-grow leading-tight hidden"></div>
  </div>
</div>

<script>
  function setVh() {
    document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
  }
  setVh();
  window.addEventListener('resize', setVh);

  const buttons = document.querySelectorAll('.control-btn');
  const stopBtn = document.getElementById('stopBtn');
  const logBox = document.getElementById('logBox');
  const motionInfo = document.getElementById('motionInfo');
  const topLimit = document.getElementById('topLimit');
  const bottomLimit = document.getElementById('bottomLimit');

  const labels = {
    upBtn: { default: 'UP', active: 'Going up' },
    stopBtn: { default: 'STOP', active: 'Stopped' },
    downBtn: { default: 'DOWN', active: 'Going down' }
  };

  let motionStart = null;
  let motionTimer = null;

  function updateMotionDisplay() {
    if (motionStart) {
      const seconds = Math.floor((Date.now() - motionStart) / 1000);
      motionInfo.textContent = `${motionInfo.dataset.icon} ${motionInfo.dataset.label} · ${seconds}s`;
    }
  }

  function startMotion(icon, label) {
    motionStart = Date.now();
    motionInfo.dataset.icon = icon;
    motionInfo.dataset.label = label;
    updateMotionDisplay();
    if (motionTimer) clearInterval(motionTimer);
    motionTimer = setInterval(updateMotionDisplay, 1000);
  }

  function stopMotion() {
    motionStart = null;
    motionInfo.textContent = '⏹ Stopped · 0s';
    if (motionTimer) {
      clearInterval(motionTimer);
      motionTimer = null;
    }
  }

  const infoPanel = document.getElementById('infoPanel');
  let logVisible = false;

  infoPanel.addEventListener('click', () => {
    logVisible = !logVisible;
    logBox.classList.toggle('hidden', !logVisible);
    infoPanel.classList.toggle('h-28', logVisible);
    infoPanel.classList.toggle('h-10', !logVisible);
  });

  function logMessage(text) {
    const timestamp = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.textContent = `[${timestamp}] ${text}`;
    logBox.appendChild(entry);
    logBox.scrollTop = logBox.scrollHeight;
  }

  const socket = io();

  socket.on('connect', () => {
    logMessage("Socket connected.")
    console.log('✅ Connected to server');
  });

  socket.on('status', data => {
    topLimit.classList.toggle('bg-green-500', data.limit.top);
    topLimit.classList.toggle('bg-gray-600', !data.limit.top);
    bottomLimit.classList.toggle('bg-green-500', data.limit.bottom);
    bottomLimit.classList.toggle('bg-gray-600', !data.limit.bottom);
  });

  socket.on('log', text => {
    logMessage(text);
  });

  window.addEventListener('load', () => {
    stopBtn.classList.add('pressed');
    stopBtn.textContent = labels.stopBtn.active;
    logMessage("UI initialized.");
    stopMotion();
  });

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      buttons.forEach(b => {
        b.classList.remove('pressed');
        b.textContent = labels[b.id].default;
      });
      btn.classList.add('pressed');
      btn.textContent = labels[btn.id].active;

      if (btn.id === 'upBtn') {
        socket.emit('command', { action: 'up' });
        startMotion('⬆', 'Moving up');
      } else if (btn.id === 'downBtn') {
        socket.emit('command', { action: 'down' });
        startMotion('⬇', 'Moving down');
      } else {
        socket.emit('command', { action: 'stop' });
        stopMotion();
      }
    });
  });
</script>

<style>
  .control-btn {
    flex: 1;
    font-size: 2rem;
    font-weight: bold;
    color: white;
    border-radius: 1rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    transition: transform 0.1s, filter 0.2s, box-shadow 0.2s;
    cursor: pointer;
    min-height: 0;
  }
  .control-btn.pressed {
    filter: brightness(0.65);
    transform: scale(0.96);
    box-shadow: inset 0 4px 10px rgba(0, 0, 0, 0.7);
  }
</style>

</body>
</html>